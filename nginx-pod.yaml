apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  default.conf: |
       upstream myapp {
        server pod-1-service:8000;
        server pod-2-service:8000;
        }

       server {
          listen 80;

          location / {
              proxy_pass http://myapp;
          }

          location /test {
            default_type text/plain;
            return 200 "nginx pod works fine\n";
          }
       }
      
---

apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: nginx-config-volume
      mountPath: /etc/nginx/conf.d/default.conf
      subPath: default.conf
  volumes:
  - name: nginx-config-volume
    configMap:
      name: nginx-config


---

apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30000
